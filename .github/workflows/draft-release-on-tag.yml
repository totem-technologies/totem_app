name: Build and Draft Release on Tag

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: draft-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  create_draft_release:
    name: Create/Update Draft Release
    runs-on: ubuntu-latest
    steps:
      - name: Create/Update Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          generate_release_notes: true

  android:
    name: Android - Build and Upload Artifacts
    runs-on: ubuntu-latest
    needs: create_draft_release
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Flutter pub get
        run: flutter pub get

      - name: Create .env file
        run: echo 'API_URL="https://www.totem.org"' > .env

      - name: Decode firebase_options.dart
        run: |
          mkdir -p lib
          echo "${{ secrets.FIREBASE_OPTIONS_B64 }}" | base64 -d > lib/firebase_options.dart

      - name: Decode google-services.json
        run: |
          mkdir -p android/app
          echo "${{ secrets.GOOGLE_SERVICES_JSON_B64 }}" | base64 -d > android/app/google-services.json

      - name: Build Android AppBundle (Release)
        run: flutter build appbundle --release

      - name: Upload AAB to Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: build/app/outputs/bundle/release/app-release.aab

  ios:
    name: iOS - Build and Upload Artifacts
    runs-on: macos-latest
    needs: create_draft_release
    env:
      IOS_CERTIFICATE_P12: ${{ secrets.IOS_CERTIFICATE_P12 }} # base64 of .p12
      IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }} # base64 of .mobileprovision
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Install Signing Certificate
        if: ${{ env.IOS_CERTIFICATE_P12 != '' }}
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ env.IOS_CERTIFICATE_P12 }}
          p12-password: ${{ env.IOS_CERTIFICATE_PASSWORD }}

      - name: Install Provisioning Profile
        if: ${{ env.IOS_PROVISIONING_PROFILE != '' }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$IOS_PROVISIONING_PROFILE" | base64 -D > ~/Library/MobileDevice/Provisioning\ Profiles/app.mobileprovision

      - name: Flutter pub get
        run: flutter pub get

      - name: Create .env file
        run: echo 'API_URL="https://www.totem.org"' > .env

      - name: Decode firebase_options.dart
        run: |
          mkdir -p lib
          echo "${{ secrets.FIREBASE_OPTIONS_B64 }}" | base64 -D > lib/firebase_options.dart

      - name: Decode GoogleService-Info.plist
        run: |
          mkdir -p ios/Runner
          echo "${{ secrets.GOOGLE_SERVICE_INFO_PLIST_B64 }}" | base64 -D > ios/Runner/GoogleService-Info.plist

      - name: Build iOS IPA (Release)
        run: |
          # flutter build ipa --release --export-options-plist=ios/ExportOptions.plist
          flutter build ipa --release

      - name: Upload IPA to Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: build/ios/ipa/*.ipa
